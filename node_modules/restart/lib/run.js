/*
 * Copyright (c) 2018-present Kriasoft | MIT License
 */

/* eslint-disable global-require, import/no-dynamic-require */

const os = require('os');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

const entry = path.resolve('%ENTRY%');
const entryHash = crypto
  .createHash('sha1')
  .update(entry)
  .digest('hex');

const modulesCache = path.resolve(os.tmpdir(), `${entryHash}.json`);

// Pre-load NPM modules used previously in order to
// optimize application launch time.
if (fs.existsSync(modulesCache)) {
  require(modulesCache)
    .reverse()
    .forEach(x => require(x));
}

process.stdin.on('data', data => {
  console.log('run.js | data');
  if (data.toString() === 'load') {
    require(entry);
    process.nextTick(() => {
      const modules = Object.keys(require.cache)
        .slice(1)
        .filter(x => /[/\\]node_modules[/\\]/.test(x));
      fs.writeFileSync(modulesCache, JSON.stringify(modules), 'utf8');
    });
  }
});
